<html>
  <head>

  <script type="text/javascript" src="shared_utils.js"></script>
  

  <script type="text/javascript" src="communication_sockets.js"></script>
  <script type="text/javascript" src="web_audio_player.js"></script>




    <style>
      body {
        font-family: "Helvetica Neue", helvetica, arial;
        padding: 15px;
      }

      ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      ul li {
        line-height: 1.4;
      }
    </style>

    <script>

      function updateStats(memuse) {
        document.getElementById('rss').innerHTML = memuse.rss;
        document.getElementById('heapTotal').innerHTML = memuse.heapTotal;
        document.getElementById('heapUsed').innerHTML = memuse.heapUsed;
      }

    // socket logic was here
    </script>


<script type="text/javascript">

"use strict";

var stens = function() {

var worker;
var flag_mode_binary_typed_array = false;

function internal_webGLStart() {

  console.log("TOP internal_webGLStart");

  // console.log("here is shared_utils ", shared_utils);

  // ------------------------------
/*
  worker = new Worker("communication_sockets.js");

  // ---

  function sayHi() {

    var curr_msg = {
      'cmd': 'start', 
      'msg': 'Hi'
    };

    console.log("browser sending msg to ww : ", curr_msg);

    // worker.postMessage({'cmd': 'start', 'msg': 'Hi'});
    worker.postMessage(curr_msg);
  };

  // ---

  worker.onmessage = function(e) {

    var data = e.data;

    if (flag_mode_binary_typed_array) {

      some_heavy_load = new Float32Array(data);

      console.log("some_heavy_load  length ", some_heavy_load.length);

      show_load(some_heavy_load);

      flag_mode_binary_typed_array = false;

    } else {

      switch (data.cmd) {

        case 'worker_returning_heavy_load' :

          console.log("worker_returning_heavy_load");

          flag_mode_binary_typed_array = true;

          // console.log("data.cmd.heavy_load ", data.cmd["heavy_load"]);


          // some_heavy_load = new Float32Array(data.cmd.heavy_load);

          // console.log("some_heavy_load length ", some_heavy_load.buffer.length);
          // console.log("some_heavy_load element 0 ", some_heavy_load.length);

          break;

        default :

          document.getElementById('result').textContent = data;
      }
    }

    // console.log("data.cmd ", data.cmd);
  }
  */

  communication_sockets.socket_client(1); // create websocket connection from browser to server

  // ------------------------------

  // var BUFF_SIZE = 512;
  // var BUFF_SIZE_TIME_DOMAIN = 512;

  // web_audio_player.init_context_audio(BUFF_SIZE, BUFF_SIZE_TIME_DOMAIN);
  web_audio_player.init_context_audio();

  // shim layer with setTimeout fallback
window.requestAnimFrame = (function(){
  return  window.requestAnimationFrame       ||
          window.webkitRequestAnimationFrame ||
          window.mozRequestAnimationFrame    ||
          function( callback ){
            // window.setTimeout(callback, 1000 / 60);
            window.setTimeout(callback, 100000);
          };
})();


// usage:
// instead of setInterval(render, 16) ....

(function animloop(){
  requestAnimFrame(animloop); // keeps alive a pointer into this block
  // render();
})();

}       //      internal_webGLStart

return {

    internal_webGLStart: internal_webGLStart
    // internal_webGLStart.sayHi : internal_webGLStart.sayHi

  
}

}();

</script>
  </head>
  <body onload="stens.internal_webGLStart();" >

    <p>  

    <button onclick="web_audio_player.render_buffer(9)">stream audio from server the right way</button>
    <!-- <button onclick="internal_webGLStart.sayHi()">sayHi</button> -->

        <br>     <!-- .....................  -->

    <button onclick="web_audio_player.render_buffer(8)">stream audio from server</button>

        <br>     <!-- .....................  -->

    <button onclick="web_audio_player.render_buffer(5)">get audio buffer from server using web sockets</button>
    <button onclick="web_audio_player.render_buffer(6)">show audio data</button>
    <button onclick="web_audio_player.render_buffer(7)">render audio from server</button>

        <br>     <!-- .....................  -->

    <button onclick="communication_sockets.socket_client(2)">send message to server</button>
    <button onclick="communication_sockets.socket_client(3)">request server send binary float</button>

        <br>     <!-- .....................  -->

    <button onclick="web_audio_player.play_tune_jam(1)">play jam from server using ye olde XMLHttpRequest</button>
    <!-- <button onclick="communication_sockets.socket_client(4)">get audio buffer from server</button> -->

        <br>     <!-- .....................  -->

    <button onclick="web_audio_player.run_synth()">do audio synth using Web Audio API</button>

    <button onclick="web_audio_player.stop_synth()">stop synth</button>

        <br>     <!-- .....................  -->

    <output id="result"></output>

    </p>

    <h1>Pings</h1>
    <ul id='pings'></ul>

    <strong>Server Stats</strong><br>
    RSS: <div id='rss'></div><br>
    Heap total: <div id='heapTotal'></div><br>
    Heap used: <div id='heapUsed'></div><br>


  </body>
</html>
